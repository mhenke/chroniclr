name: Update Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force:
        description: 'Force update all documents'
        required: false
        default: 'false'
      pr:
        description: 'PR number to analyze'
        required: false
        type: string
      since:
        description: 'Update documents since date (YYYY-MM-DD)'
        required: false
        type: string

jobs:
  update-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      discussions: read
      issues: write
      models: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Determine update parameters
        id: params
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Workflow dispatch with custom parameters
            echo "Using workflow dispatch parameters"
            
            if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
              echo "FORCE_UPDATE=--force" >> $GITHUB_ENV
            fi
            
            if [[ -n "${{ github.event.inputs.pr }}" ]]; then
              echo "PR_NUMBER=--pr=${{ github.event.inputs.pr }}" >> $GITHUB_ENV
            fi
            
            if [[ -n "${{ github.event.inputs.since }}" ]]; then
              echo "SINCE=--since=${{ github.event.inputs.since }}" >> $GITHUB_ENV
            fi
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR event
            echo "Using PR #${{ github.event.pull_request.number }}"
            echo "PR_NUMBER=--pr=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          fi

      - name: Update documentation
        run: |
          ARGS=""
          [ "$FORCE_UPDATE" ] && ARGS="$ARGS $FORCE_UPDATE"
          [ "$PR_NUMBER" ] && ARGS="$ARGS $PR_NUMBER"
          [ "$SINCE" ] && ARGS="$ARGS $SINCE"
          npm run update-documents -- $ARGS
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request with document updates
        if: github.event_name != 'pull_request' || github.event.pull_request.state != 'closed'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs: update documentation based on changes'
          title: 'Update documentation'
          body: |
            This PR updates documentation based on recent code changes.

            ${PR_NUMBER:+Related to PR #${PR_NUMBER}}
            ${SINCE:+Updates since: ${SINCE}}
            ${FORCE_UPDATE:+Force update: true}

            Generated by the Chroniclr Document Update System.
          branch: docs/auto-update-${{ github.run_id }}
          delete-branch: true
          labels: documentation
